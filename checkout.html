<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - PrimeCast</title>
    <meta name="description" content="Complete your PrimeCast IPTV subscription purchase">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <img src="images/logo.png" alt="PrimeCast Logo" style="height: 45px; width: auto;">
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle mobile menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="channels.html">Channels</a></li>
                    <li><a href="pricing.html">Pricing</a></li>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Checkout Container -->
    <div class="checkout-container">
        <h1 style="color: var(--gold); text-align: center; margin-bottom: 10px;">Complete Your Order</h1>
        <p style="text-align: center; color: var(--text-gray); margin-bottom: 40px;">
            Your order reference: <span class="reference-display" id="orderReference">Generating...</span>
        </p>

        <!-- Important Notice -->
        <div class="info-box" style="background: rgba(196, 155, 42, 0.1); border-color: var(--gold);">
            <h3 style="color: var(--gold); margin-bottom: 15px;">üìß Login Information</h3>
            <p>Your login information will be emailed to you after we verify your e-transfer payment.</p>
            <p>Our team typically processes orders within 1-4 hours.</p>
        </div>

        <!-- Order Summary -->
        <div class="checkout-section">
            <h2>Order Summary</h2>
            <div class="order-summary" id="orderSummary">
                <div class="summary-row">
                    <span>Plan:</span>
                    <span id="planName">Loading...</span>
                </div>
                <div class="summary-row">
                    <span>Duration:</span>
                    <span id="planDuration">Loading...</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="planPrice">$0</span>
                </div>
            </div>
        </div>

        <!-- E-transfer Payment Instructions -->
        <div class="checkout-section">
            <h2>üè¶ Pay with Interac E-transfer (Canada)</h2>
            
            <div class="payment-method">
                <h3 style="color: var(--gold); margin-bottom: 20px;">Payment Instructions</h3>
                
                <div class="info-box" style="margin-bottom: 25px;">
                    <p><strong>Step 1: Send E-transfer</strong></p>
                    <div class="email-copy" style="margin: 15px 0;">
                        <input type="text" id="etransferEmail" value="info@primecast.world" readonly aria-label="E-transfer email address">
                        <button class="btn-copy" onclick="copyEmail()" id="copyEmailBtn">Copy Email</button>
                    </div>
                    <p style="margin-top: 15px;"><strong>Step 2: Include your order reference in the e-transfer message:</strong></p>
                    <div class="reference-display" style="font-size: 1.1rem; margin-top: 10px;">
                        <span id="orderReferenceDisplay">PC-xxxxx</span>
                        <button class="btn-copy" onclick="copyReference()" id="copyRefBtn" style="margin-left: 10px; padding: 8px 16px; font-size: 0.9rem;">Copy Reference</button>
                    </div>
                    <p style="margin-top: 15px;"><strong>Step 3: Complete the transfer and save your confirmation number</strong></p>
                    <p style="margin-top: 15px;"><strong>Step 4: Fill out the form below with your confirmation number</strong></p>
                </div>

                <form id="etransferForm" style="margin-top: 25px;">
                    <div class="form-group">
                        <label for="customerName">Your Name *</label>
                        <input 
                            type="text" 
                            id="customerName" 
                            name="customerName"
                            placeholder="John Doe" 
                            required
                            minlength="2"
                            maxlength="100"
                            aria-required="true">
                        <span class="error-message-inline" id="nameError" style="display: none;"></span>
                    </div>

                    <div class="form-group">
                        <label for="customerEmail">Your Email Address *</label>
                        <input 
                            type="email" 
                            id="customerEmail" 
                            name="customerEmail"
                            placeholder="your@email.com" 
                            required
                            aria-required="true">
                        <span class="error-message-inline" id="emailError" style="display: none;"></span>
                    </div>

                    <div class="form-group">
                        <label for="etransferReference">E-transfer Confirmation Number *</label>
                        <input 
                            type="text" 
                            id="etransferReference" 
                            name="etransferReference"
                            placeholder="Enter the confirmation number from your e-transfer" 
                            required
                            minlength="3"
                            maxlength="100"
                            aria-required="true">
                        <span class="error-message-inline" id="referenceError" style="display: none;"></span>
                        <small style="color: var(--text-gray); display: block; margin-top: 5px;">
                            This is the confirmation number you received after sending the e-transfer
                        </small>
                    </div>

                    <input type="hidden" id="selectedPlan" value="">
                    <input type="hidden" id="planAmount" value="">
                    <input type="hidden" id="orderRef" value="">
                    <input type="hidden" id="csrfToken" name="csrf_token" value="">
                    
                    <button type="submit" class="btn btn-primary" id="etransferSubmitBtn" style="width: 100%;">
                        Submit Order
                    </button>
                    <p style="text-align: center; color: var(--text-gray); margin-top: 15px; font-size: 14px;">
                        You'll receive login credentials via email within 1-4 hours after we verify your payment
                    </p>
                </form>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="info-box" style="margin-top: 30px;">
            <p style="text-align: center;">üîí Your information is secure and encrypted</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo">
                        <img src="images/logo.png" alt="PrimeCast Logo" style="height: 45px; width: auto;">
                    </div>
                    <p>Premium IPTV Streaming Service</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="channels.html">Channels</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="contact.html">Contact Us</a></li>
                        <li><a href="mailto:info@primecast.world">info@primecast.world</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 PrimeCast. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        // Load CSRF token immediately
        (async function loadCSRFToken() {
            try {
                const response = await fetch('php/get_csrf_token.php');
                const data = await response.json();
                if (data.success && data.token) {
                    document.getElementById('csrfToken').value = data.token;
                }
            } catch (error) {
                console.error('Failed to load CSRF token:', error);
            }
        })();

        // Plan configuration
        const plans = {
            'basic': { 
                name: 'Basic Plan (1 Month)', 
                duration: '1 Month', 
                price: '$25', 
                value: '25.00'
            },
            'standard': { 
                name: 'Standard Plan (3 Months)', 
                duration: '3 Months', 
                price: '$60', 
                value: '60.00'
            },
            'premium': { 
                name: 'Premium Plan (12 Months)', 
                duration: '12 Months', 
                price: '$150', 
                value: '150.00'
            }
        };

        // Get plan from URL
        const urlParams = new URLSearchParams(window.location.search);
        const plan = urlParams.get('plan') || 'basic';
        
        // Validate plan exists
        if (!plans[plan]) {
            alert('Invalid plan selected. Redirecting to pricing page.');
            window.location.href = 'pricing.html';
        }
        
        // Update order summary
        document.getElementById('planName').textContent = plans[plan].name;
        document.getElementById('planDuration').textContent = plans[plan].duration;
        document.getElementById('planPrice').textContent = plans[plan].price;
        document.getElementById('selectedPlan').value = plans[plan].name;
        document.getElementById('planAmount').value = plans[plan].value;

        // Generate and display order reference
        const reference = generateReference();
        sessionStorage.setItem('orderReference', reference);
        document.getElementById('orderReference').textContent = reference;
        document.getElementById('orderReferenceDisplay').textContent = reference;
        document.getElementById('orderRef').value = reference;

        // Copy email function
        function copyEmail() {
            const emailInput = document.getElementById('etransferEmail');
            emailInput.select();
            emailInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(emailInput.value).then(() => {
                const copyBtn = document.getElementById('copyEmailBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úì Copied!';
                copyBtn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy. Please manually copy: info@primecast.world');
            });
        }

        // Copy reference function
        function copyReference() {
            const reference = document.getElementById('orderReferenceDisplay').textContent;
            
            navigator.clipboard.writeText(reference).then(() => {
                const copyBtn = document.getElementById('copyRefBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úì Copied!';
                copyBtn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy. Please manually copy: ' + reference);
            });
        }

        // Form validation
        function validateName() {
            const input = document.getElementById('customerName');
            const error = document.getElementById('nameError');
            const value = input.value.trim();
            
            if (!value) {
                input.classList.add('error');
                error.textContent = 'Name is required';
                error.style.display = 'block';
                return false;
            } else if (value.length < 2) {
                input.classList.add('error');
                error.textContent = 'Name must be at least 2 characters';
                error.style.display = 'block';
                return false;
            } else {
                input.classList.remove('error');
                input.classList.add('success');
                error.style.display = 'none';
                return true;
            }
        }

        function validateEmail() {
            const input = document.getElementById('customerEmail');
            const error = document.getElementById('emailError');
            const value = input.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!value) {
                input.classList.add('error');
                error.textContent = 'Email is required';
                error.style.display = 'block';
                return false;
            } else if (!emailRegex.test(value)) {
                input.classList.add('error');
                error.textContent = 'Please enter a valid email address';
                error.style.display = 'block';
                return false;
            } else {
                input.classList.remove('error');
                input.classList.add('success');
                error.style.display = 'none';
                return true;
            }
        }

        function validateReference() {
            const input = document.getElementById('etransferReference');
            const error = document.getElementById('referenceError');
            const value = input.value.trim();
            
            if (!value) {
                input.classList.add('error');
                error.textContent = 'E-transfer confirmation number is required';
                error.style.display = 'block';
                return false;
            } else if (value.length < 3) {
                input.classList.add('error');
                error.textContent = 'Please enter a valid confirmation number';
                error.style.display = 'block';
                return false;
            } else {
                input.classList.remove('error');
                input.classList.add('success');
                error.style.display = 'none';
                return true;
            }
        }

        // Real-time validation
        document.getElementById('customerName').addEventListener('blur', validateName);
        document.getElementById('customerEmail').addEventListener('blur', validateEmail);
        document.getElementById('etransferReference').addEventListener('blur', validateReference);

        // Clear errors on input
        ['customerName', 'customerEmail', 'etransferReference'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                if (this.classList.contains('error')) {
                    this.classList.remove('error');
                    const errorId = id === 'customerName' ? 'nameError' : 
                                   id === 'customerEmail' ? 'emailError' : 'referenceError';
                    document.getElementById(errorId).style.display = 'none';
                }
            });
        });

        // Form submission
        document.getElementById('etransferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate all fields
            const nameValid = validateName();
            const emailValid = validateEmail();
            const referenceValid = validateReference();
            
            if (!nameValid || !emailValid || !referenceValid) {
                alert('Please fix the errors above before submitting.');
                return;
            }
            
            const submitBtn = document.getElementById('etransferSubmitBtn');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            
            const formData = {
                name: document.getElementById('customerName').value.trim(),
                email: document.getElementById('customerEmail').value.trim(),
                plan: document.getElementById('selectedPlan').value,
                amount: document.getElementById('planAmount').value,
                order_reference: document.getElementById('orderRef').value,
                etransfer_reference: document.getElementById('etransferReference').value.trim(),
                csrf_token: document.getElementById('csrfToken').value
            };
            
            try {
                const response = await fetch('php/submit_order.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    window.location.href = 'thankyou.html';
                } else {
                    alert(result.error || 'There was an issue submitting your order. Please contact us at info@primecast.world');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                }
            } catch (error) {
                console.error('Order submission error:', error);
                alert('There was an error processing your order. Please contact us at info@primecast.world with your order reference: ' + formData.order_reference);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        });
    </script>
</body>
</html>
